<?xml version="1.0" encoding="utf-8"?>
<modification>
  <name>autologin</name>                
  <code>autologin</code>                
  <version>1.0</version>           
  <author>vvvdata</author>           
  <link>https://vvvdata.ru</link>  
 
<file path="system/library/session.php">  
  <operation>
    <search>                           
      <![CDATA[
      public function destroy()
      ]]>
    </search>
    <add position="before">             
      <![CDATA[
    public function maxlifetime() {
		return $this->adaptor->maxlifetime_other;
	  }
      ]]>
    </add>
  </operation>    
</file>

<file path="system/library/session/db.php">  
  <operation>
    <search>                           
      <![CDATA[
        $this->maxlifetime = ini_get('session.gc_maxlifetime') !== null ? (int)ini_get('session.gc_maxlifetime') : 1440;
      ]]>
    </search>
    <add position="after">             
      <![CDATA[
		$status = false; $maxlifetime = 1800; // min 30 minutes
		$query_maxlifetime = $this->db->query("SELECT * FROM " . DB_PREFIX . "setting WHERE store_id = '0' AND (`key` = 'module_autologin_session' OR  `key` = 'module_autologin_status')");
		if ($query_maxlifetime->num_rows){        
			foreach($query_maxlifetime->rows as $mlt){
			if($mlt['key'] == 'module_autologin_session' && (int)$mlt['value'] > $maxlifetime)
			$maxlifetime = (int)$mlt['value'];
			if($mlt['key'] == 'module_autologin_status' && $mlt['value']) 
			   $status = true;            
			}		
	  }
		if($status){
				$this->maxlifetime = $maxlifetime  + time();
				$this->maxlifetime_other = $this->maxlifetime;
			}
      else $this->maxlifetime = (int)$this->maxlifetime + time(); 
      ]]>
    </add>
  </operation>  
  <operation>
    <search>                           
      <![CDATA[
      public $maxlifetime;
      ]]>
    </search>
    <add position="after">             
      <![CDATA[
      public $maxlifetime_other = 0;
      ]]>
    </add>
  </operation>
  <operation>
    <search>                           
      <![CDATA[
      if ($session_id)
      ]]>
    </search>
    <add position="replace">             
      <![CDATA[
      if ($session_id && (count($_COOKIE) > 0))
      ]]>
    </add>
  </operation>
  <operation>
    <search>                           
      <![CDATA[time() + (int)$this->maxlifetime]]>
    </search>
    <add position="replace">             
      <![CDATA[$this->maxlifetime]]>
    </add>
  </operation>
</file>

<file path="catalog/controller/startup/session.php">
  <operation>
    <search>                          
      <![CDATA[
        $this->session->start($session_id);
      ]]>
    </search>
    <add position="before">             
      <![CDATA[
    $maxlifetime = $this->session->maxlifetime();
      ]]>
    </add>
  </operation> 
  <operation>
    <search>                           
      <![CDATA[ini_get('session.cookie_lifetime')]]>
    </search>
    <add position="replace">             
      <![CDATA[$maxlifetime]]>
    </add>
  </operation>
</file>

<file path="system/framework.php">
  <operation>
    <search>                          
      <![CDATA[
        $session->start($session_id);
      ]]>
    </search>
    <add position="before">             
      <![CDATA[
      $maxlifetime = $session->maxlifetime();
      ]]>
    </add>
  </operation>  
  <operation>
    <search>                           
      <![CDATA[ini_get('session.cookie_lifetime')]]>
    </search>
    <add position="replace">             
      <![CDATA[$maxlifetime]]>
    </add>
  </operation>
</file>

<file path="system/library/cart/cart.php">
  <operation  error="skip">
    <search>                          
      <![CDATA[
      $this->weight = $registry->get('weight');
      ]]>
    </search>
    <add position="after">             
      <![CDATA[
    $status = false; $maxlifetime = 1; // min 1 HOUR
		$query_maxlifetime = $this->db->query("SELECT * FROM " . DB_PREFIX . "setting WHERE store_id = '0' AND (`key` = 'module_autologin_cart' OR  `key` = 'module_autologin_status')");
		if ($query_maxlifetime->num_rows){        
		  foreach($query_maxlifetime->rows as $mlt){
		  if($mlt['key'] == 'module_autologin_cart' && (int)$mlt['value'] > $maxlifetime)
		  $maxlifetime = (int)$mlt['value'];
		  if($mlt['key'] == 'module_autologin_status' && $mlt['value']) 
		   $status = true;
		  }		
		}
		if(!$status)$maxlifetime = 1;
      ]]>
    </add>
  </operation>
  
  <operation  error="skip">
    <search>                           
      <![CDATA[INTERVAL 1 HOUR]]>
    </search>
    <add position="replace">             
      <![CDATA[INTERVAL $maxlifetime HOUR]]>
    </add>
  </operation>
</file>
</modification>